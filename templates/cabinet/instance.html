{% extends '../base/base-cabinet.html' %}

{% block content %}

<div class="container-fluid pt-4 px-4">
    <div class="row g-4">

        <div class="col-sm-12 col-md-6 col-xl-4">
            <div class="bg-secondary rounded h-100 p-4">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <h6 class="mb-0">Инстанс #{{ instance }}</h6>
                    {% if status == 'nodriver' %}
                    <p>Драйвер не запущен</p>                    
                    {% elif status == 'wrongurl' %}
                    <p>Неправильный URL</p>
                    {% elif status == 'noauth' %}
                    <p>Неавторизован</p>                    
                    {% elif status == 'auth' %}
                    <p>Авторизован</p>
                    {% endif %}
                </div>

                <div>
                    {% if status == 'nodriver' %}
                    <a type="button" onclick="createDriver('{{ instance }}')" class="btn btn-success w-100">Перезапустить драйвер</a>
                    {% elif status == 'noauth' %}
                    <a type="button" onclick="openDriver('{{ instance }}')" class="btn btn-success w-100">Обновить QR код</a>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if status == 'noauth' %}
        <div class="col-sm-12 col-md-6 col-xl-4">
            <div class="bg-secondary rounded h-100 p-4">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <h6 class="mb-0">QR код</h6>
                </div>
                <div class="d-flex justify-content-center" style="background-color: aliceblue;">
                    <div class="p-3" id="qrcode"></div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div id="alert"></div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
<script type="text/javascript">
    function createDriver(instance){
        fetch("{% url 'create_driver' %}", {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({'instance': instance})
        })        
    }

    function openDriver(instance){
        getQR(instance);
        checkAuth(instance);
    }

    async function getQR(instance){
        $.ajax({
            url: "{% url 'get_qr' %}",
            type: 'GET',
            data: {'instance': instance},
            success: function (response) {
                document.getElementById("qrcode").innerHTML = "";
                new QRCode(document.getElementById("qrcode"), response);
            }
        })        
    }

    async function checkAuth(instance) {
        for (var i = 0; i < 30; i++) {
            await new Promise(resolve => {
                $.ajax({
                    url: "{% url 'check_auth' %}",
                    type: 'GET',
                    data: {'instance': instance},
                    success: function (response) {
                        console.log(response);
                        if (response === 'auth') {
                            console.log('auth' + String(i));
                            document.getElementById("qrcode").innerHTML = "";
                            location.reload();
                        }
                        resolve();
                    }
                })         
            });
        }
    }

</script>

{% endblock content %}